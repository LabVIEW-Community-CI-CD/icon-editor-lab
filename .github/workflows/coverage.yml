name: PR Coverage Gate

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

jobs:
  coverage:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Ensure Pester v6
        shell: pwsh
        run: |
          Set-PSRepository PSGallery -InstallationPolicy Trusted
          Install-Module Pester -MinimumVersion 6.0.0 -Force -Scope CurrentUser

      - name: Prepare artifacts dirs
        shell: pwsh
        run: New-Item -ItemType Directory -Force -Path artifacts/coverage,artifacts/test-results | Out-Null

      - name: Run Pester with Cobertura + JUnit
        shell: pwsh
        run: |
          Invoke-Pester -Configuration @{
            Run         = @{ Path = 'tests' }
            CodeCoverage= @{ Enabled = $true; OutputFormat = 'Cobertura'; OutputPath = 'artifacts/coverage/coverage.xml' }
            TestResult  = @{ Enabled = $true; OutputFormat = 'JUnitXml';  OutputPath = 'artifacts/test-results/results.xml' }
          }

      - name: Enforce coverage thresholds (>= 75% line)
        shell: pwsh
        run: |
          if (-not (Test-Path artifacts/coverage/coverage.xml)) {
            Write-Error "Missing coverage.xml"
            exit 1
          }
          [xml]$doc = Get-Content artifacts/coverage/coverage.xml
          $rate = [double]$doc.coverage.GetAttribute('line-rate')
          $pct  = [math]::Round($rate*100,2)
          $min  = 75
          if ($pct -lt $min) { Write-Error "Coverage $pct% < $min%"; exit 1 }
          Write-Host "Coverage OK: $pct% >= $min%"

      - name: Upload coverage.xml
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-xml
          path: artifacts/coverage/coverage.xml

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-results
          path: artifacts/test-results/results.xml
